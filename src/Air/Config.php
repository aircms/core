<?php

declare(strict_types=1);

namespace Air;

use Air\Crud\Nav;
use Air\Type\RichContent;
use Throwable;

class Config
{
  public static function defaults(
    ?string $title = 'AirCms',
    ?array  $settings = null,
    ?array  $extensions = [],
    array   $nav = [],
    array   $routes = [],
    bool    $strictRoutes = true,
    bool    $reportErrors = false,
    ?array  $richContent = null,
    string  $timezone = "Europe/Kyiv",
    bool    $single = false,
  ): array
  {
    $appEntryPoint = realpath(dirname($_SERVER['SCRIPT_FILENAME'], 2));

    if (!$routes && is_file($appEntryPoint . '/config/routes.php')) {
      $routes = require_once $appEntryPoint . '/config/routes.php';
    }

    if (!$nav && is_file($appEntryPoint . '/config/nav.php')) {
      $nav = require_once $appEntryPoint . '/config/nav.php';
    }

    $contextAvailable = false;

    try {
      foreach (glob($appEntryPoint . '/app/Context/*') as $folder) {
        $contextAvailable = true;
        $folder = realpath($folder);

        if (is_dir($folder)) {
          if (is_file($folder . '/Routes.php')) {
            $routes = array_merge($routes, require_once $folder . '/Routes.php');
          }
          if (is_file($folder . '/Config.php')) {
            $extensions[lcfirst(basename($folder))] = require_once $folder . '/Config.php';
          }
        }
      }
    } catch (Throwable) {
      $contextAvailable = false;
    }

    $router = [];
    $modules = [];

    if (!$single) {
      $modules['modules'] = '\\App\\Module';
      $router = [
        'cli' => [
          'module' => 'cli'
        ],
        'admin.*' => [
          'module' => 'admin',
          'air' => [
            'asset' => [
              'underscore' => false,
              'prefix' => '/assets/air',
            ],
          ],
        ],
        'api.*' => [
          'strict' => $strictRoutes,
          'module' => 'api',
          'routes' => $routes,
          'air' => [
            'strictInject' => true,
            'contexts' => $contextAvailable ? '\\App\\Context' : null
          ],
        ],
        '*' => [
          'strict' => $strictRoutes,
          'module' => 'ui',
          'routes' => $routes,
          'air' => [
            'strictInject' => true,
            'asset' => [
              'underscore' => false,
              'prefix' => '/assets/ui',
            ],
          ],
        ]
      ];
    }

    return array_replace_recursive(
      [
        'air' => [
          ...$modules,
          'exception' => $reportErrors,
          'phpIni' => [
            'display_errors' => $reportErrors ? '1' : '0',
          ],
          'startup' => [
            'error_reporting' => $reportErrors ? E_ALL : 0,
            'date_default_timezone_set' => $timezone,
          ],
          'loader' => [
            'namespace' => 'App',
            'path' => $appEntryPoint . '/app',
          ],
          'db' => [
            'driver' => 'mongodb',
            'servers' => [[
              'host' => 'localhost',
              'port' => 27017,
            ]],
            'db' => getenv('AIR_DB_DB')
          ],
          'storage' => [
            'url' => getenv('AIR_FS_URL'),
            'key' => getenv('AIR_FS_KEY'),
          ],
          'logs' => [
            'enabled' => true,
            'exception' => true,
          ],
          'crypt' => [
            'secret' => getenv('AIR_CRYPT_SECRET'),
          ],
          'fontsUi' => 'fontsUi',
          'admin' => [
            'title' => $title,
            'logo' => '/assets/air/logo.png',
            'favicon' => '/assets/air/logo.png',
            'notAllowed' => '_notAllowed',
            'settings' => $settings ?: Nav::getAllSettings(),
            'rich-content' => $richContent ?: RichContent::getAllTypes(),
            'auth' => [
              'route' => '_auth',
              'source' => 'database',
              'root' => [
                'login' => getenv('AIR_ADMIN_AUTH_ROOT_LOGIN'),
                'password' => getenv('AIR_ADMIN_AUTH_ROOT_PASSWORD'),
              ],
            ],
            'tiny' => getenv('AIR_ADMIN_TINY_KEY'),
            'menu' => $nav,
          ],
        ],
        ...$router
      ],
      $extensions ?: []
    );
  }
}
